= Upgrade or patch a cluster
:last_updated: 01/10/2020
:linkattrs:
:page-aliases: /admin/system-admin/upgrade-a-cluster.adoc
:experimental:

Learn how to upgrade a cluster to a new release, or patch a cluster to update services and allow for bug fixes.

'''
> **ThoughtSpot Training**
>
> * For best results when upgrading or patching ThoughtSpot, we recommend that you take the following ThoughtSpot U course: https://training.thoughtspot.com/create-upgrade-patch-a-thoughtspot-cluster/431164[Upgrade & Patch a Cluster^].
> * See other training resources at https://training.thoughtspot.com/[ThoughtSpot U^].

'''

== About cluster upgrades and patches
ThoughtSpot is installed or updated from a release tarball that contains the ThoughtSpot application (binaries and configuration), third-party software, and Operating System image.
Third party softwares are licensed software components necessary for operation of the ThoughtSpot application.
These include Java, Boost C{pp} libraries, Google protocol buffers, and so on.

ThoughtSpot patches the Operating System at the time of upgrades.
Installation and upgrade use the same process, replacing the older OS image on a node by the new image delivered in the release tarball.

ThoughtSpot Support will contact you to schedule an update when a minor or major upgrade becomes available.

== Upgrade a cluster
To upgrade your cluster, follow these steps:
[cols="5,~",grid=none,frame=none]
|===
| &#10063; | <<upgrade-step-1,Step 1: Check cluster health>>
| &#10063; | <<upgrade-step-2,Step 2: Download the release>>
| &#10063; | <<upgrade-step-3,Step 3: Upgrade the cluster>>
| &#10063; | <<upgrade-step-4,Step 4: Finalize installation>>
|===

[#upgrade-step-1]
=== Step 1: Check cluster health
. SSH into your cluster.
Run `ssh admin@<nodeIP>`.
+
Replace `nodeIP` with your specific network information.
+
[source,bash]
----
 $ ssh admin@<nodeIP>
----

. Run `tscli cluster status`. This tells you what version you are currently on, and ensures that the cluster is running and ready.
+
[source,bash]
----
 $ tscli cluster status
----

. Run `tscli cluster check` to ensure there are no component failures.
+
[source,bash]
----
 $ tscli cluster check
----

. If `tscli cluster status` or `tscli cluster check` return any failures, xref:contact.adoc[contact ThoughtSpot Support] before you proceed with the upgrade.

[#upgrade-step-2]
=== Step 2: Download the release
. Use `tscli fileserver download-release` to download the release bundle.
+
You must xref:tscli-command-ref.adoc#tscli-fileserver[configure the fileserver] by running `tscli fileserver configure` before you can download the release.
+
[source,bash]
----
$ tscli fileserver download-release <release-number> --user <username> --out <release-location>
----
+
Note the following parameters:
+
`release-number`:: is the release number of your ThoughtSpot instance, such as 5.3, 5.3.1, 6.0, and so on.
`username`:: is the username for the fileserver that you set up earlier, when configuring the fileserver.
`release-location`:: is the location path of the release bundle on your local machine. For example, `/export/sdb1/TS_TASKS/install/6.0.tar.gz`.

. Copy the downloaded release bundle to a specific path in the `/export` folder.
+
You must copy the bundle to a different path in the `/export` folder, depending on your deployment platform:
+
--
SMC, Dell, VMware, and GCP:: `/export/sdb1/TS_SRE_TASKS`
AWS:: `/export/xvdb1/TS_SRE_TASKS`
Azure:: `/export/sdc1/TS_SRE_TASKS`
--
+
Run `scp <release-number>.tar.gz admin@<hostname>:/export/sdb1/TS_TASKS/install/<file-name>`.
+
[source,bash]
----
$ scp <release-number>.tar.gz admin@<hostname>:/export/sdb1/TS_TASKS/install/<file-name>
----
+
Note the following parameters:
+
`release-number`:: is the release number of your ThoughtSpot instance, such as 5.3, 5.3.1, 6.0, and so on.
`hostname`:: is your specific hostname.
`file-name`:: is the name of the tarball file on your local machine.

NOTE: You can use another secure copy method, if you prefer a method other than the `scp` command.

[#upgrade-step-3]
=== Step 3: Upgrade the cluster
. Run `tscli cluster update <release-number>.tar.gz`.
+
Note the following parameters:

`release-number`:: is the release number of your ThoughtSpot installation, such as `6.0`, `5.3`, `5.3.1`, and so on.

. The nodes reboot one by one. Wait about 15 minutes before you log back in.

. To see which step the upgrade is in, run `tscli cluster status --tail`.
+
[source,bash]
----
$ tscli cluster status --tail
----
+
NOTE: During the upgrade process, some services may temporarily be unavailable. Their status in the `tscli cluster status --tail` command might be `FAILURE`. The service should return to `SUCCESS` as the upgrade continues. If a service continues to fail, xref:contact.adoc[contact ThoughtSpot Support].

. The upgrade takes about 1.5 hours to complete, including the objects upgrader.

[#upgrade-step-4]
=== Finalize installation
. After the upgrade completes, log out of the shell.
+
[source,bash]
----
$ logout
----

. `SSH` back into the cluster.
Run `ssh admin@<nodeIP>`.
+
Replace `nodeIP` with your specific network information.
+
[source,bash]
----
 $ ssh admin@<nodeIP>
----

. To check that the cluster is ready, run `tscli cluster status`.
+
[source,bash]
----
 $ tscli cluster status
----
+
Ensure that the `DATABASE` and `SEARCH ENGINE` fields in the `tscli cluster status` command show `READY`.

. Sign in to the ThoughtSpot application on your browser.

== Patch a cluster
To patch your cluster, follow these steps:
[cols="5,~",grid=none,frame=none]
|===
| &#10063; | <<patch-step-1,Step 1: Obtain cluster patch>>
| &#10063; | <<patch-step-2,Step 2: Verify patch integrity>>
| &#10063; | <<patch-step-3,Step 3: Apply the patch to the cluster>>
| &#10063; | <<patch-step-4,Step 4: Finalize installation>>
|===

[#patch-step-1]
=== Obtain cluster patch
ThoughtSpot Support must provide you with the correct patch to apply. Do not apply any other patches. xref:contact.adoc[] to obtain the correct cluster patch.

After ThoughtSpot Support supplies you with the patch, copy it to your cluster.

[#patch-step-2]
=== Step 2: Verify patch integrity
To verify the integrity of the patch file, check the checksum.

Run `md5sum -c <patch-name>.tar.gz.MD5checksum`.

[source,bash]
----
 $ md5sum -c <patch-name>.tar.gz.MD5checksum
----

Your output says `ok` if you have the correct release.

[#patch-step-3]
=== Step 3: Apply the patch to the cluster
Run `tscli patch apply <patch-name>`.
[source,bash]
----
 $ tscli patch apply <patch-name
----
The patch process takes about 10 minutes.

[#patch-step-4]
=== Step 4: Finalize installation
Ensure that ThoughtSpot applied the patch successfully.

Run `tscli patch ls` and look for the new patch name.

[source,bash]
----
 $ tscli patch ls
----
