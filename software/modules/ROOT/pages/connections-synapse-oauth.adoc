= Configure OAuth for a Synapse connection
:experimental:
:last_updated: 2/9/2022
:linkattrs:

ThoughtSpot supports OAuth for a Microsoft Azure Synapse connection. This page describes the setup and configuration required for using OAuth2.0 with Azure AD as the IdP for Azure Synapse connections.

[#part-1]
== Part 1: Create AD application in Azure

The first step in setting up OAuth with Azure AD as an IdP is to create an active directory application in Azure.

1. Log in to the  Azure portal and navigate to “Azure Active Directory” resource.
2. Under Manage click **App registrations** and then **New registration**.
+
image::azure-app-registrations.png[]
+
The Register an application appears.
+
image::azure-register-application.png[]

3. Enter a name for the application, and select the supported account types.

4. For the Redirect URI, enter your ThoughtSpot instance’s hostname in the following format: `\https://<your_instance_name>/callosum/v1/connection/generateTokens`, and click **Register**.
+
For example: `\https://myTS.com/callosum/v1/connection/generateTokens`.
+
The OAuth client application creation is complete.
+
image::azure-application-complete.png[]

5. Make a note of the **Application (client) ID** which you will use later in the OAuth2.0 authorization workflow.
+
You will now create the client secret for your application.

6. In the application you just created, click **Certificates & Secrets**.
+

image::azure-cert-secrets.png[]

7. Click **New client secret** to create a secret for the application. This secret will also be used in OAuth2.0 authorization flow along with client ID.

8. Under **API / Permissions name**, for Azure SQL Database, add the **user_impersonation** permission, as shown in the following image.
+
Delegated type indicates that the application will authenticate on behalf of the user.
+
image::azure-config-permissions.png[]

9. From the application home page, click **Endpoints** and make a note of the OAuth2.0 authorization and token endpoints.
+
image::azure-application-endpoints.png[]

== Part 2: Set active directory admin for database server

An active directory user must be set as Admin for the SQL server.

1. Navigate to the SQL server associated with the Synapse deployment and click **Active Directory Admin**.
+
image::azure-ad-1.png[]

2. At the top of the page, click **Set admin** to search for users in the directory, and select the user you want to set as administrator for the server.
+
image::azure-ad-2.png[]
+
You should now see the **Admin name** set for the server.
+
Active directory is now linked  with the SQL database.

== Part 3: Create database user

1. Create the AD user you want to use for database login by logging into the database with the administrator user you set earlier.

2. Use the following DDL in the following format to create the user:
+
`CREATE USER [<email_address@company>] FROM EXTERNAL PROVIDER;`
+
**Example**:
+
`CREATE USER [admin@example.com] FROM EXTERNAL PROVIDER;`
+
This is referred to as a “contained user” created in the database mapped to Azure AD identity. For details, see Microsoft's documentation:
https://docs.microsoft.com/en-us/azure/azure-sql/database/authentication-aad-configure?tabs=azure-powershell#create-contained-users-mapped-to-azure-ad-identities[Create contained users mapped to Azure AD identities^].
+
You cannot manage database roles for AD users from Azure. You must manage them from the database side.

== Troubleshooting

If the following `Invalid Resource` error appears on initial login, you must update the API permissions.

image::synapse-oauth-error1.png[An Invalid Resource error message]

Under **API / Permissions name**, for Azure SQL Database, add the **user_impersonation** permission, as shown in the following image.

The *Delegated* type indicates that the application will authenticate on behalf of the user.

image::azure-config-permissions.png[Add the user impersonation permission with the delegated type]


'''
> **Related information**
>
> * xref:connections-synapse-add.adoc[Add a Synapse connection]
> * xref:connections-synapse-edit.adoc[]
> * xref:connections-synapse-remap.adoc[]
> * xref:connections-synapse-delete-table.adoc[]
> * xref:connections-synapse-delete-table-dependencies.adoc[]
> * xref:connections-synapse-delete.adoc[]
> * xref:connections-synapse-reference.adoc[Reference]
> * xref:connections-query-tags.adoc#tag-synapse[Synapse query tags]