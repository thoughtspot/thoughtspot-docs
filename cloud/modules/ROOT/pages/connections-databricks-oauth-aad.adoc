= Configure OAuth with AAD for a {connection} connection 
:last_updated: 6/7/2022
:linkattrs:
:page-aliases:
:experimental:
:page-layout: default-cloud
:connection: Databricks
:description: ThoughtSpot supports OAuth for a Databricks connection.
:jira: SCAL-199788, SCAL-201978, SCAL-203358

ThoughtSpot supports OAuth for a {connection} connection. This page describes the setup and configuration required.

Databricks SQL warehouses are configured with OAuth 2.0 authentication. ThoughtSpot supports all IDPs supported by Databricks in OAuth 2.0, including Microsoft Azure’s Azure Active Directory (AAD), AWS, and Okta. As an example, this article documents how to set up OAuth for Microsoft Azure AAD.

NOTE: For OAuth, we recommend checking the {connection} link:https://docs.databricks.com/en/administration-guide/users-groups/single-sign-on/index.html[documentation] to confirm any IDP support and their details. This article documents only the most frequently set-up IDP.


== Part 1: Create an application in AAD

To create an application in AAD, do the following:

. Sign in to the Azure portal and navigate to the AAD resource, click *Add*, and select *App registration*.
+
image::databricks-oauth-config-1.png[Click Add and select App registration]
. Provide a name for your application and add a redirect URI in the following format:
+
`\https://<your-thoughtspot-instance>/callosum/v1/connection/generateTokens`
+
This is where the call is redirected upon successful login to AAD when creating a connection in ThoughtSpot.
+
image::databricks-oauth-config-2.png[Register an application]

. After you register your application, make a note of the *Application (client) ID* in the Essentials section of the app’s overview page. Also, make a note of the OAuth 2.0 authorization and token endpoints. These are required later when configuring the {connection} connection in ThoughtSpot.
+
image::databricks-oauth-config-3.png[View the Application ID, OAuth 2.0 authorization endpoint, and OAuth 2.0 token endpoint in the Essentials section]

== Part 2: Configure the AAD application

To configure the AAD application, do the following:

. In the Azure portal, navigate to your application by selecting *App Registrations* and then selecting your newly registered application to open it.
+
image::databricks-oauth-config-4.png[Click on your new application]

. In your application, click *API Permissions* and under the *AzureDatabricks* API/Permissions name, select the *user_impersonation* permission.
+
image::databricks-oauth-config-5.png[Click user_impersonation]
. Select *Certificates & secrets* and create a new secret for the app, providing an appropriate expiry time. Make a note of the secret value because it is displayed _only_ while creating it. The secret value is required later when you create the {connection} connection in ThoughtSpot.
+
.Setting the scope of the authorization flow
****
In the authorization code flow for OAuth, the scope must be set with this resource id:
[source]
----
2ff814a6-3304-4ab8-85cb-cd0e6f879c1d/.default offline_access openid
----
For more information, see https://docs.microsoft.com/en-us/azure/databricks/dev-tools/api/latest/aad/app-aad-token[Get Azure AD tokens by using the Microsoft Authentication Library^] in Microsoft's Azure {connection} documentation.
****

== Part 3: Create AAD users in the {connection} workspace

To create AAD users in the {connection} workspace, do the following:

. Sign in to the {connection} workspace as a user with admin privileges. Select *Setting* and navigate to *Admin Console*.
. Select *Add User* to create AAD users in {connection}.
+
image::databricks-oauth-config-6.png[Click add user]

////
== Part 4: Connect the client using the OAuth token
The JDBC connection URL which uses the access token from AAD must use the following format:
[source]
----
`"jdbc:spark://adb-111222444555.13.azuredatabricks.net:443/samples;transportMode=http;" +
"ssl=1;httpPath=/sql/1.0/endpoints/c53335555f2222e999;" +
"AuthMech=11;Auth_Flow=0;" +"Auth_AccessToken=<access_token>"`
----
////

== Logging in to a connection created by another user using OAuth

As an admin user, you may run into an issue logging in to connections created using OAuth. To resolve this issue, complete the following steps:

. Search on a table belonging to the connection you are trying to edit. The following error appears:
+
image:oauth-error.png[Error reading “Error in loading data. Connection to Snowflake could not be established. OAuth login required. Login”]

. Click *Login*. You will be directed to the IDP login page.

. Enter your login credentials.

. You will now have access to edit the connection.

== Limitation

ThoughtSpot does not support link:https://docs.databricks.com/en/integrations/jdbc/authentication.html#oauth-machine-to-machine-m2m-authentication[OAuth machine-to-machine authentication], also known as Service Principal and OAuth authentication.


'''
> **Related information**
>
> * xref:connections-databricks-add.adoc[Add a {connection} connection]
> * xref:connections-databricks-edit.adoc[Edit a {connection} connection]
> * xref:connections-databricks-remap.adoc[Remap a {connection} connection]
> * xref:connections-databricks-delete-table.adoc[Delete a table from a {connection} connection]
> * xref:connections-databricks-delete-table-dependencies.adoc[Delete a table with dependent objects]
> * xref:connections-databricks-delete.adoc[Delete a {connection} connection]
> * xref:connections-databricks-private-link.adoc[]
> * xref:connections-databricks-reference.adoc[Connection reference for {connection}]
> * xref:connections-databricks-passthrough.adoc[]
> * xref:connections-column-indexing-oauth.adoc[]
