= Configure Okta OAuth for a {connection} connection
:experimental:
:last_updated: 1/25/2022
:linkattrs:
:page-layout: default-cloud
:connection: Snowflake
:description: Learn how to configure Okta OAuth for a Snowflake connection in ThoughtSpot.
:jira: SCAL-160062

ThoughtSpot supports Okta OAuth for a {connection} connection.

To configure Okta OAuth for {connection}, you create an app in the Identity Provider and use the app’s credentials to register it in {connection} as an external token provider. Once these steps are completed, {connection} will allow connections issued by the IdP.

NOTE: The steps provided here are an example of how you can configure Okta for external OAuth. You can use any OAuth flow provided that you can get the information required for the security integration. The following steps provide a guide for getting the information required to create the security integration for Snowflake.

IMPORTANT: Be sure to consult your organization's security policies for configuring an authorization server to make sure you meet all requirements.

[#part-1]
== Part 1: Configuring the IdP with Okta

The following steps detail the configuration of IdP with Okta as an example. You can set up any other OpenID Connect (OIDC)-based IdP providers following a similar process. For details, refer to the respective documentation for those.

To configure the IdP with Okta, do the following:

. Sign in to the Okta console with a user having administrator privileges. Navigate to the *Applications* page in the console and select *Create App Integration*.
+
image::dremio-oauth1.png[Click Create App Integration]
+
. For sign-in method, choose *OIDC - OpenID Connect*.
. For application type, choose *Web Application*
. Select *Next*.
. Under Grant type, make sure *Authorization Code* and *Refresh Token* are selected.
+
image::sf-oauth2.png[Select both Authorization Code and Refresh Token]

. For Sign-in redirect URIs, add the ThoughtSpot redirect URI for the application.
+
It should follow this format:
+
`\https://<your-thoughtspot-instance-host>/callosum/v1/connection/generateTokens`
+
image::dremio-oauth3.png[Add the ThoughtSpot redirect URI]

. Assign the application to everyone in the organization or to specific groups. This step may vary for other IdPs.
+
image::dremio-oauth4.png[Assign the application]
. Collect the client credentials from the application home page and make a note of them. These will be required later for adding the external token provider in {connection}.
+
image::sf-oauth5.png[Make a note of the client credentials]
. Go to menu:Security[API], and make a note of the value for Audience. This is required in a later step
for configuring the OpenID well-known URI for the authorization server.
+
image::dremio-oauth6.png[Make a note of the Audience value]
+
For Okta, it should follow this format:
+
`\https://<organization>.okta..com/oauth2/<unique_id>/.well-known/oauth-authorization-server`
. Open the URL in a browser and make a note of the values for the following parameters:
- Issuer
- Authorization endpoint
- JWKS URI
- Token endpoint

[#part-2]
== Part 2: Create {connection} scopes in Okta

To create scopes in Okta that correspond to your {connection} database, do the following:

. Navigate to menu:Security[API].
+
image::sf-okta-api-1.png[Select Security > API]
+
. Select the authorization server used by the client application created in the previous steps to add scopes.
. Add snowflake roles in the format: *_session:role:<snowflake_db_role>_*.
+
image::sf-okta-add-scopes.png[Add Snowflake roles]
+
TIP: The scope “role-any” has a special purpose. For details, see https://docs.snowflake.com/en/user-guide/oauth-okta.html#using-any-role-with-external-oauth[Using ANY Role with External OAuth^] in Snowflake's documentation.

[#part-3]
== Part 3: Create security integration in {connection}

- Create a security integration in your Snowflake database using the following command:
+
[source]
----
create security integration external_oauth_okta_2
    type = external_oauth
    enabled = true
    external_oauth_type = okta
    external_oauth_any_role_mode = 'ENABLE'
    external_oauth_issuer = '<OKTA_ISSUER>'
    external_oauth_jws_keys_url = '<OKTA_JWS_KEY_ENDPOINT>'
    external_oauth_audience_list = ('<SNOWFLAKE_AUDIENCE>')
    external_oauth_token_user_mapping_claim = 'sub'
    external_oauth_snowflake_user_mapping_attribute = 'login_name';
----

TIP: If you want to ensure your Okta OAuth configuration is correct for use with ThoughtSpot, you can validate it following procedures similar to those in xref:connections-snowflake-azure-ad-oauth.adoc#validate-config[Validating your Azure configuration].

== Logging in to a connection created by another user using OAuth

As an admin user, you may run into an issue logging in to connections created using OAuth. To resolve this issue, complete the following steps:

. Search on a table belonging to the connection you are trying to edit. The following error appears:
+
image:oauth-error.png[Error reading “Error in loading data. Connection to Snowflake could not be established. OAuth login required. Login”]

. Click *Login*. You will be directed to the IDP login page.

. Enter your login credentials.

. You will now have access to edit the connection.

== OAuth connection improvements

If you do not have a valid OAuth access token, you can now directly navigate to the OAuth authorization screen when performing one of the following actions on a connection shared with you:

** View sample data
** Create a custom SQL view
** Edit the connection
** Upload a CSV file

'''
> **Related information**
>
> * xref:connections-snowflake-add.adoc[Add a {connection} connection]
> * xref:connections-snowflake-edit.adoc[Edit a {connection} connection]
> * xref:connections-snowflake-remap.adoc[Remap a {connection} connection]
> * xref:connections-snowflake-external-tables.adoc[Query external tables from your {connection} connection]
> * xref:connections-snowflake-delete-table.adoc[Delete a table from a {connection} connection]
> * xref:connections-snowflake-delete-table-dependencies.adoc[Delete a table with dependent objects]
> * xref:connections-snowflake-delete.adoc[Delete a {connection} connection]
> * xref:connections-snowflake-oauth.adoc[Configure OAuth]
> * xref:connections-snowflake-azure-ad-oauth.adoc[Configure Azure AD OAuth]
> * xref:connections-snowflake-best.adoc[Best practices for {connection} connections]
> * xref:connections-snowflake-private-link.adoc[]
> * xref:connections-snowflake-psc.adoc[]
> * xref:connections-snowflake-reference.adoc[Connection reference for {connection}]
> * xref:connections-query-tags.adoc#tag-snowflake[ThoughtSpot query tags in Snowflake]
> * xref:connections-snowflake-passthrough.adoc[]
> * xref:connections-column-indexing-oauth.adoc[]

