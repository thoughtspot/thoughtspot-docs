= Integrate with dbt
:last_updated: 6/8/2022
:linkattrs:
:experimental:
:page-layout: default-cloud
:author: Teresa Killmond
:description: ThoughtSpot's dbt sync allows you to provide your existing dbt models and create ThoughtSpot Worksheets, which you can use to search your data.
:jira: SCAL-182271, SCAL-182987

ThoughtSpot's dbt sync allows you to easily provide your existing dbt models and automatically create ThoughtSpot xref:worksheets.adoc[Worksheets], which you can use to xref:search-data.adoc[search your data].

dbt takes your raw data in your data warehouse and transforms and validates it. ThoughtSpot's dbt sync connects users to their cloud data warehouse, integrates with your dbt models using an API key or zip file, and generates the relationships between the tables defined in the dbt model that you select. It also brings any logical tables into ThoughtSpot. Then, ThoughtSpot creates new Worksheets, based on the relationships between the tables. If a table does not have any relationships, ThoughtSpot creates a Worksheet based only on that table. These Worksheets provide user-friendly logical views of your complex datasets. Users can use these Worksheets to easily search their complex data. This process may replace existing dbt tables you imported into ThoughtSpot, but it will not replace existing Worksheets.

NOTE: Integration with dbt is certified only for Amazon Redshift, Databricks, Google BigQuery, and Snowflake connections.

[#prerequisites]
== Prerequisites
Before you can integrate with dbt, you must satisfy the following prerequisites

* Create a xref:connections.adoc[connection] to your external cloud data warehouse: Amazon Redshift, Databricks, Google BigQuery, or Snowflake. This cloud data warehouse must contain the tables that are created from your dbt models.
* If you are using a single-tenant dbt environment, you must ask your dbt contact to enable access to the https://docs.getdbt.com/dbt-cloud/api-v2[dbt Cloud API v2 (2.0.0)^].
* If you connect to dbt via *dbt cloud*, you need the API key, Account ID, and Project ID:
+
API key:: This is also called the *API token* in dbt. To find this token, refer to the https://docs.getdbt.com/docs/dbt-cloud-apis/user-tokens[dbt documentation^].
Account ID:: Your default dbt Cloud account ID. Find your account ID in your dbt Cloud URL, after you sign in. For example, if your URL is `https://cloud.getdbt.com/#/accounts/12345/projects/56789/dashboard`, your account ID is `12345`.
Project ID:: Find your project ID in your dbt Cloud URL, after you sign in. For example, if your URL is `https://cloud.getdbt.com/#/accounts/12345/projects/56789/dashboard`, your project ID is `56789`.
* Optionally define the relationships for the dbt models in your `yml` schema file. For more information, refer to the https://docs.getdbt.com/docs/build/tests[dbt documentation^].
+
NOTE: If you do not define relationships, ThoughtSpot imports each model as a single table and creates one Worksheet based on each table.

NOTE: Manage your ThoughtSpot Worksheet and table xref:data-modeling-settings.adoc[column properties] and table xref:join-worksheet-edit.adoc[joins] in dbt by using metadata tags to define column properties and joins within your dbt model schema. See xref:dbt-integration-metadata-tags.adoc[].

* To ensure ThoughtSpot can process the latest changes defined in your `yml` schema file, which defines relationships, metatags, and tests, you must have the latest versions of the `manifest.json` and `catalog.json` files. To ensure you have the latest versions of those files, run a dbt job, which generates the latest versions of these files.
* If you are using *dbt cloud*, the *generate docs on run* setting must be on. You can enable this setting in the jobs settings of the project, under *Execution settings*.
* If you are using *dbt core*, execute the `dbt docs generate` command along with the `dbt run` command.
* If you are using *dbt core*, you must connect to dbt using a zip file, which must contain the latest `manifest.json` and `catalog.json` files. By default, dbt stores these files under the `<project name>/target` folder.
+
NOTE: When you compress the `manifest.json` and `catalog.json` files into one zip file, ensure that you do not include any hidden files, as this may cause errors later. To check the folder you plan to compress does not contain hidden files, refer to these articles for viewing hidden files on your https://discussions.apple.com/thread/7581737[Mac^] or https://support.microsoft.com/en-us/windows/view-hidden-files-and-folders-in-windows-97fbc472-c603-9d90-91d0-1166d1d9f4b5[Windows^] computer. If the folder contains hidden files, move them out of the folder before compressing it into a zip file.

[#integrate]
== dbt sync
You can set up your dbt sync from the Data workspace. To integrate with dbt, follow these steps:

. Ensure that you have already xref:connections.adoc[created a connection] to your external cloud data warehouse. This cloud data warehouse must contain the tables that are created from your dbt models.

. Select *Data* in the top navigation bar.

. Select *dbt* in the side navigation bar.

. Select *Add dbt connection* in the upper right corner. The dbt integration wizard opens.
+
image::dbt-integration-connect.png[dbt integration step 1]

. Under *Data warehouse*, select the cloud data warehouse you would like to use from the dropdown menu, or search for it using the search bar in the dropdown menu. You can also select *Add new connection,* which opens the connection creation wizard.

. Under *Database*, select the database within the cloud data warehouse that you would like to use from the dropdown menu, or search for it using the search bar in the dropdown menu. This database must contain the tables that are created from your dbt models.

. Under *Connect to dbt project*, select either *Via dbt cloud* or *Use a .zip file*. If you are using *dbt core*, you must select *Use a .zip file*.

. Under *URL*, specify the beginning of your dbt URL. For example, if your URL is `https://cloud.getdbt.com/#/accounts/12345/projects/56789/dashboard`, put `https://cloud.getdbt.com` in the URL text box.

. If you select *Via dbt cloud* under *Connect to dbt project*, fill in the following parameters:
+
API key:: This is also called the *API token* in dbt. To find this token, navigate to your *Account Settings* page in dbt cloud. Select the *Service Account tokens* page, and generate a new token.
Account ID:: Your default dbt Cloud account ID. Find your account ID in your dbt Cloud URL, after you sign in. For example, if your URL is `https://cloud.getdbt.com/#/accounts/12345/projects/56789/dashboard`, your account ID is `12345`.
Project ID:: Find your project ID in your dbt Cloud URL, after you sign in. For example, if your URL is `https://cloud.getdbt.com/#/accounts/12345/projects/56789/dashboard`, your project ID is `56789`.

. If you select *Use a .zip file* under *Connect to dbt project*, select the *Upload* button, and add the zip file from your files. The zip file must contain the latest `manifest.json` and `catalog.json` files. By default, dbt stores these files under the `<project name>/target` folder.
+
NOTE: When you compress the `manifest.json` and `catalog.json` files into one zip file, ensure that you do not include any hidden files, as this may cause errors later. To check the folder you plan to compress does not contain hidden files, refer to these articles for viewing hidden files on your https://discussions.apple.com/thread/7581737[Mac^] or https://support.microsoft.com/en-us/windows/view-hidden-files-and-folders-in-windows-97fbc472-c603-9d90-91d0-1166d1d9f4b5[Windows^] computer. If the folder contains hidden files, move them out of the folder before compressing it into a zip file.

. Select *Next*.
. If you receive the following error, make sure you executed the dbt project with the `GENERATE DOCS` option `ON`, and verify that you entered the API key, account ID, and project ID correctly. If you are using *dbt cloud*, ensure that the `generate docs on run` setting is on. You can enable this setting in the jobs settings of the project, under *Execution settings*. If you are using *dbt core*, execute the `dbt docs generate` command along with the `dbt run` command. After verifying everything, run the dbt connection again.
+
----
Unable to connect to dbt project. Please verify API key and retry
----
+
image::dbt-error-message.png[Error message saying "Unable to connect to dbt project. Please verify API key and retry"]

. If you receive the following error, you may need to switch to an older version of dbt. ThoughtSpot supports dbt for versions 1.5 and earlier. Navigate to dbt and go to *Deploy > Environments > Environment_Name > Settings*. Click the dbt Version menu and scroll down to select 1.5.
+
----
Unable to fetch dbt models
----
+
image::dbt-error.png[Error message saying "Unable to fetch dbt models"]

. On the next screen, select up to 4 dbt folders to import. ThoughtSpot lists the model names, paths, and the number of tables they have.
+
To increase the maximum number of dbt folders you can import at a time, contact {support-url}.
+
image::dbt-integration-folder-multiple.png[dbt integration step 2]

. Select *Next*.

. On the next screen, select tables or models to import. By default, ThoughtSpot imports all models in the folder(s). Deselect any models you do not want to import. You must select at least 1 model within each dbt folder.
+
The *Synced* column appears if you enabled *Incremental updates* in your environment. See <<edit,Editing a dbt project>>. The *Synced* column says *No* if this is the first time you are importing this model. The *Synced* column says *Yes* if you are importing the same model again. If the *Synced* column says *Yes*, ThoughtSpot will update the existing ThoughtSpot objects, instead of creating new objects.
+
image::dbt-integration-tables.png[dbt integration step 3]

. On the next screen, choose which Worksheets you would like ThoughtSpot to create, based on the models and relationships specified.
+
The *Synced* column appears if you enabled *Incremental updates* in your environment. See <<edit,Editing a dbt project>>. The *Synced* column says *No* if this is the first time you are importing this Worksheet. The *Synced* column says *Yes* if you are importing the same Worksheet again. If the *Synced* column says *Yes*, ThoughtSpot will update the existing Worksheet, instead of creating a new one.
+
image::dbt-integration-worksheets-create.png[Select Worksheets for ThoughtSpot to create]

. Select *Finish*.

. The *Generated Tables, Worksheets and Liveboards* page appears. ThoughtSpot generates several tables, Worksheets, and Liveboards from your dbt models.
+
image::dbt-integration-worksheets.png[dbt integration step 4]
+
To inspect the table, Worksheet, and Liveboard details, select any of the table, Worksheet, or Liveboard names. You can view the joins created between the related tables in the Worksheets from the *Joins* tab for the Worksheet.
+
To xref:search-data.adoc[search the data] on the Worksheets, select *Search worksheet* next to any Worksheet.

. Select *Exit*.

. To see the objects that you just created from dbt, navigate to the *Data > Home* or *Liveboards* pages.
+
image::dbt-integration-home-page.png[dbt integration view Worksheets and tables]
+
NOTE: This process may replace existing dbt tables you imported into ThoughtSpot, but it will not replace existing Worksheets.

. If you select any of the tables or Worksheets you created, and then click *Joins*, you can see the joins ThoughtSpot created, based on the relationships in dbt.


== How the dbt sync works

To integrate with dbt, ThoughtSpot reads information from the latest versions of the `manifest.json` and `catalog.json` files. In the <<prerequisites,prerequisites>>, you ensured that ThoughtSpot could find these files, either by enabling the *generate docs on run* setting in dbt cloud, or by creating a zip file with your `manifest.json` and `catalog.json` files for dbt core.

ThoughtSpot reads the following information from the `manifest.json` file. Make sure that the `manifest.json` file contains the latest details of your `yml` schema file.

* Database name
* Schema name
* Model/Table name
* Table description
* Column name
* Column description
* Table relationships (joins)

ThoughtSpot reads the following information from the `catalog.json` file:

* Column data types

=== How ThoughtSpot creates Worksheets from dbt

ThoughtSpot creates Worksheets based on the table relationships defined in a .yml schema file in the *models* directory.

The Worksheet creation follows these steps:

. ThoughtSpot creates logical tables based on the model files. In the following example, ThoughtSpot creates a table for d_customer, d_product, d_product_category, and so on.

. ThoughtSpot creates joins between the logical tables, based on the relationships defined in the .yml schema file. In the following example, ThoughtSpot creates joins between d_product and d_product_category, d_shipping and d_customer, and so on.

. ThoughtSpot creates Worksheets made up of the logical tables, based on the relationships defined in the .yml schema file.

For example, based on the following .yml schema file, ThoughtSpot creates the following Worksheets:

Download the yml schema file link:{attachmentsdir}/schema-example.yml[here].

[%collapsible]
.Click to view the yml schema file
====
--
include::partial$schema-example.adoc[]
--
====

|===
| Model name | Relationship to | Worksheet created?

|d_customer | none | No. This model file only has relationships _from_ other model files. It does not have relationships _to_ other model files.
|d_product | d_product_category | Yes. The Worksheet consists of the 2 tables: d_product and d_product_category.
|d_shipping | d_customer | Yes. The Worksheet consists of the 2 tables: d_shipping and d_customer.
|d_product_category | none | No. This model file only has relationships _from_ other model files. It does not have relationships _to_ other model files.
| f_inventory | d_product, d_product_category | Yes. The Worksheet consists of the 3 tables: f_inventory, d_product, and d_product_category.
| f_order | d_customer, d_shipping, d_product, d_product_category | Yes. The Worksheet consists of the 5 tables: f_order, d_customer, d_shipping, d_product, and d_product_category.
|===


[#edit]
== Editing a dbt project
If there are any changes to the dbt models that you would like the ThoughtSpot Worksheets, Liveboards, and tables to reflect, you must edit the dbt sync you created. This updates the existing Worksheets, Liveboards, and tables.

.[.badge.badge-beta]#Beta#
****
Updating your existing dbt sync Worksheets, Liveboards, and tables is in beta and off by default. ThoughtSpot also calls this feature *incremental updates*. To enable it, contact {support-url}.

If incremental updates is off in your environment, editing a dbt sync creates new Worksheets, Liveboards, and tables. It does not update the existing objects.
****

To edit a dbt project/ integration, follow these steps:

. Select *Data* in the top navigation bar.

. Select *dbt* in the side navigation bar.
+
NOTE: When you edit a dbt sync, you often add columns and descriptions to your currently synced tables and worksheets. To simplify the process of editing a sync, ThoughtSpot pre-selects the folders, models, and worksheets you selected during your first sync.

. In the list of dbt projects, select the empty checkbox next to your project name. If necessary, use the search bar in the upper left corner to find your project.

. Select *Edit*.

. Run the dbt sync again, making any changes you would like. Follow the steps in <<integrate,Integrating with dbt>>. This updates your Worksheets, tables, and Liveboards, based on the changes in your dbt models.
+
NOTE: You may generate an error if you have removed or renamed a column in dbt before re-syncing to ThoughtSpot. To handle this error, check your dbt models and tables to ensure every column maps correctly to the tables and models in ThoughtSpot.



== Limitations

* By default, you can only connect to a maximum of 4 dbt folders at a time. To increase this maximum, contact {support-url}.

* You must import at least 1 table.

* Integration with dbt is certified only for Amazon Redshift, Databricks, Google BigQuery, and Snowflake connections.

* If you make changes to your dbt models in dbt, ThoughtSpot does not automatically reflect those changes. You must integrate with dbt again. This may affect changes you made to the tables and Worksheets in ThoughtSpot.

* When you edit a dbt project in ThoughtSpot, you can't remove table and Worksheet columns, or joins. You can only add them.

* When you edit a dbt project in ThoughtSpot, you can't change the column datatype.

== Troubleshooting

For help troubleshooting issues with your dbt sync, see https://community.thoughtspot.com/s/article/Common-errors-encountered-during-dbt-Integration[Common errors encountered during dbt integration^].

'''
> **Related information**
>
> * xref:dbt-integration-metadata-tags.adoc[Metadata tags for dbt]
