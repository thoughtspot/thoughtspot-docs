= Configure OAuth for a {connection} connection
:experimental:
:last_updated: 1/25/2022
:linkattrs:
:page-aliases: connections-starburst-okta-oauth.adoc
:page-layout: default-cloud
:connection: Starburst
:description: How to configure OAuth for a Starburst connection in ThoughtSpot.
:jira: SCAL-160062, SCAL-199788

To configure OAuth for {connection}, you create an app in the Identity Provider and use the app’s credentials to register it in {connection} as an external token provider. Once these steps are completed, {connection} will allow connections coming in with the JWT issued by the IdP.

NOTE: For OAuth, we recommend checking the {connection} link:https://docs.starburst.io/latest/security/authentication-types.html[documentation] to confirm any IDP support and their details. This article documents only the most frequently set-up IDP.

IMPORTANT: Each ThoughtSpot instance requires a unique {connection} security integration.
Each user in {connection} must have a default warehouse and default role.

== Okta OAuth
The following steps are an example of how you can configure Okta for external OAuth.

[#azure-ad-oauth]
== Azure AD OAuth
For details on how to configure Microsoft Azure AD OAuth for Starburst, see https://docs.starburst.io/latest/security/oauth2-providers.html#azure-active-directory[Starburst's Azure Active Directory documentation^].

NOTE: You can use any OAuth flow provided that you can get the information required for the security integration. The following steps provide a guide for getting the information required to create the security integration for Snowflake.

IMPORTANT: Be sure to consult your organization's security policies for configuring an authorization server to make sure you meet all requirements.

[#part-1]
== Part 1: Configuring the IdP with Okta

The following steps detail the configuration of IdP with Okta as an example. You can set up any other OpenID Connect (OIDC)-based IdP providers following a similar process. For details, refer to the respective documentation for those.

To configure the IdP with Okta, do the following:

. Sign in to the Okta console with a user that has administrator privileges. Navigate to the *Applications* page in the console and select *Create App Integration*.
+
image::dremio-oauth1.png[Click Create App Integration]
+
. For sign-in method, choose *OIDC - OpenID Connect*.
. For application type, choose *Web Application*
. Select *Next*.
. Under Grant type, make sure *Authorization Code* and *Refresh Token* are selected.
+
image::starburst-oauth2.png[Select Authorization Code and Refresh Token]

. For Sign-in redirect URIs, add the ThoughtSpot redirect URI for the application.
+
It should follow this format:
+
`\https://<your-thoughtspot-instance-host>/callosum/v1/connection/generateTokens`
+
image::dremio-oauth3.png[Add the ThoughtSpot redirect URI]

. Assign the application to everyone in the organization or to specific groups. This step may vary for other IdPs.
+
image::dremio-oauth4.png[Assign the application]
. Collect the client credentials from the application home page and make a note of them. These will be required later for adding the external token provider in {connection}.
+
image::starburst-oauth5.png[Make a note of the client credentials]
. Go to menu:Security[API], and make a note of the value for Audience. This is required in a later step
for configuring the OpenID well-known URI for the authorization server.
+
image::dremio-oauth6.png[Make a note of the Audience value]
+
For Okta, it should follow this format:
+
`\https://<organization>.okta..com/oauth2/<unique_id>/.well-known/oauth-authorization-server`
. Open the URL in a browser and make a note of the values for the following parameters:
- Issuer
- Authorization endpoint
- JWKS URI
- Token endpoint

[#part-2]
== Part 2: Adding external token provider in {connection}

To add an external token provider in {connection}, do the following:

- From the installation folder, open `<install_dir>/etc/config.properties` and add the following properties:
+
[source]
----
http-server.authentication.type=PASSWORD,JWT
http-server.authentication.jwt.key-file=<value of jwks_uri from open id config>
http-server.authentication.jwt.required-issuer=<value of issuer from open id config>
http-server.authentication.jwt.required-audience=<value of audience frmo open id config>
http-server.authentication.jwt.principal-field=<value of the claim containing the user name>
----
+
These details should be obtained from the well known open id configuration URL obtained from Okta authorization server (for example, *\https://example.okta.com/oauth2/abc1234xyz/.well-known/oauth-authorization-server*).
+
The value for the principal-field configuration should be the claim name in the JWT that contains the username matching the username created in Starburst. This can be found from the token payload. In the following example, the username is in the claim “sub.”
+
image::dremio-oauth8.png[Sample external token provider code]

== Logging in to a connection created by another user using OAuth

As an admin user, you may run into an issue logging in to connections created using OAuth. To resolve this issue, complete the following steps:

. Search on a table belonging to the connection you are trying to edit. The following error appears:
+
image:oauth-error.png[Error reading “Error in loading data. Connection to Snowflake could not be established. OAuth login required. Login”]

. Click *Login*. You will be directed to the IDP login page.

. Enter your login credentials.

. You will now have access to edit the connection.

== OAuth connection improvements

If you do not have a valid OAuth access token, you can now directly navigate to the OAuth authorization screen when performing one of the following actions on a connection shared with you:

** View sample data
** Create a custom SQL view
** Edit the connection



'''
> **Related information**
>
> * https://docs.starburst.io/latest/security/jwt.html[JWT authentication^] in Starburst documentation
> * xref:connections-starburst-add.adoc[Add a {connection} connection]
> * xref:connections-starburst-edit.adoc[Edit a {connection} connection]
> * xref:connections-starburst-remap.adoc[Remap a {connection} connection]
> * xref:connections-starburst-delete-table.adoc[Delete a table from a {connection} connection]
> * xref:connections-starburst-delete-table-dependencies.adoc[Delete a table with dependent objects]
> * xref:connections-starburst-delete.adoc[Delete a {connection} connection]
> * xref:connections-starburst-reference.adoc[Connection reference for {connection}]
> * xref:connections-starburst-private-link.adoc[]
> * xref:connections-starburst-passthrough.adoc[]
> * xref:connections-column-indexing-oauth.adoc[]